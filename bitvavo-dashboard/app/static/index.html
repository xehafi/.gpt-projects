<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Bitvavo Bot Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:20px; max-width:1100px}
    .tabs{display:flex; gap:8px; margin-bottom:12px}
    .tabbtn{padding:8px 12px; border:1px solid #ccc; background:#f7f7f7; border-radius:6px; cursor:pointer}
    .tabbtn.active{background:#e8f0ff; border-color:#6a8dff}
    .tab{display:none}
    .tab.active{display:block}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    .card{border:1px solid #ddd; border-radius:8px; padding:12px}
    button{padding:8px 12px; margin-right:8px}
    input,select{padding:6px; width:100%}
    pre{background:#111;color:#0f0;padding:10px;border-radius:6px;max-height:300px;overflow:auto}
    .badge{padding:2px 8px; border-radius:12px; background:#eee}
    table{width:100%; border-collapse:collapse; font-size:14px}
    th,td{border-bottom:1px solid #eee; padding:6px 4px}
    th{text-align:left}
    td.num{text-align:right}
  </style>
</head>
<body>
  <h2>Bitvavo Bot Dashboard</h2>

  <div class="tabs">
    <button class="tabbtn active" data-t="home" onclick="showTab('home', this)">Home</button>
    <button class="tabbtn" data-t="favorites" onclick="showTab('favorites', this)">Favorites</button>
  </div>

  <!-- HOME TAB -->
  <div id="tab-home" class="tab active">
    <div class="grid">
      <div class="card">
        <h3>Status</h3>
        <div id="status">
          <div>Running: <span class="badge" id="running">false</span></div>
          <div>Mode: <span id="mode">paper</span></div>
          <div>Symbol: <span id="symbol">BTC/EUR</span></div>
          <div>Timeframe: <span id="tf">1m</span></div>
          <div>Last Price: €<span id="px">-</span></div>
          <div>Position Qty: <span id="qty">0</span></div>
          <div>Equity: €<span id="eq">-</span></div>
          <div>Last Action: <span id="act">-</span></div>
        </div>
        <p>
          <button onclick="post('/api/start')">Start</button>
          <button onclick="post('/api/stop')">Stop</button>
        </p>
      </div>

      <div class="card">
        <h3>Config</h3>
        <form id="cfg">
          <label>Mode
            <select name="BOT_MODE">
              <option value="paper">paper</option>
              <option value="live">live</option>
            </select>
          </label><br><br>
          <label>Symbol <input name="BOT_SYMBOL" value="BTC/EUR"></label><br><br>
          <label>Timeframe <input name="BOT_TIMEFRAME" value="1m"></label><br><br>
          <label>Risk Fraction (0-1) <input name="BOT_RISK_FRACTION" value="0.95"></label><br><br>
          <label>Take Profit % <input name="TAKE_PROFIT_PCT" value="0.04"></label><br><br>
          <label>Stop Loss % <input name="STOP_LOSS_PCT" value="0.02"></label><br><br>
          <label>LIVE_TRADING (YES/NO) <input name="LIVE_TRADING" value="NO"></label><br><br>
          <label>LIVE_CONFIRM (I_UNDERSTAND) <input name="LIVE_CONFIRM" value=""></label><br><br>
          <button type="button" onclick="save()">Save & Reload</button>
        </form>
        <small>Changing values writes to <code>.env</code> and reloads the bot config.</small>
      </div>

      <div class="card" style="grid-column:1 / span 2">
        <h3>Holdings (Bitvavo)</h3>
        <button onclick="loadHoldings()">Refresh</button>
        <table>
          <thead>
            <tr>
              <th>Asset</th>
              <th class="num">Free</th>
              <th class="num">Used</th>
              <th class="num">Total</th>
              <th class="num">Price (EUR)</th>
              <th class="num">Value (EUR)</th>
            </tr>
          </thead>
          <tbody id="holdbody"></tbody>
          <tfoot>
            <tr>
              <th colspan="5" class="num">Total Value (EUR)</th>
              <th class="num" id="holdtotal">-</th>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="card" style="grid-column:1 / span 2">
        <h3>Logs</h3>
        <pre id="logs"></pre>
      </div>
    </div>
  </div>

  <!-- FAVORITES TAB -->
  <div id="tab-favorites" class="tab">
    <div class="card">
      <h3>Favorites Status</h3>
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <button onclick="loadFavs()">Refresh</button>
        <input id="syncAsset" placeholder="Asset (e.g., XRP-EUR or ALL)" style="max-width:220px;padding:6px">
        <button onclick="syncPrices('hourly')">Sync Hourly → pricehistory</button>
        <button onclick="syncPrices('latest')">Sync 24h (5m) → latestpricehistory</button>
      </div>
      <table id="favtbl" style="margin-top:10px">
        <thead>
          <tr>
            <th>Name</th>
            <th>Asset</th>
            <th class="num">Price</th>
            <th class="num">SMA(s)</th>
            <th class="num">SMA(l)</th>
            <th class="num">RSI</th>
            <th>Signal</th>
            <th>Error</th>
          </tr>
        </thead>
        <tbody id="favbody"></tbody>
      </table>
    </div>
  </div>

<script>
function showTab(t, el){
  document.querySelectorAll('.tab').forEach(d=>d.classList.remove('active'));
  document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+t).classList.add('active');
  el.classList.add('active');
}

async function get(url){ const r=await fetch(url); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function post(url, body){ const r=await fetch(url,{method:'POST', headers:{'Content-Type':'application/json'}, body: body?JSON.stringify(body):null}); if(!r.ok) throw new Error(await r.text()); return r.json(); }

async function refresh(){
  try{
    const s = await get('/api/status');
    document.getElementById('running').textContent=s.running;
    document.getElementById('mode').textContent=s.mode;
    document.getElementById('symbol').textContent=s.symbol;
    document.getElementById('tf').textContent=s.timeframe;
    document.getElementById('px').textContent=(s.last_price??'-');
    document.getElementById('qty').textContent=s.position_qty?.toFixed ? s.position_qty.toFixed(6) : s.position_qty;
    document.getElementById('eq').textContent=(s.equity??'-');
    document.getElementById('act').textContent=s.last_action??'-';
  }catch(e){}
  try{
    const t = await fetch('/api/logs'); document.getElementById('logs').textContent = await t.text();
  }catch(e){}
}

async function loadConf(){
  const c = await get('/api/config');
  for (const k of Object.keys(c)){
    const el = document.querySelector(`[name="${k}"]`);
    if (el) el.value = c[k];
  }
}

async function save(){
  const data = {};
  new FormData(document.getElementById('cfg')).forEach((v,k)=>data[k]=v);
  await post('/api/config', data);
  await loadConf(); await refresh();
}

async function loadHoldings(){
  const tbody = document.getElementById("holdbody");
  const totalEl = document.getElementById("holdtotal");
  tbody.innerHTML = `<tr><td colspan="6">Loading...</td></tr>`;
  try{
    const d = await get('/api/home/holdings');
    const items = d.items || [];
    tbody.innerHTML = "";
    items.forEach(it=>{
      const tr = document.createElement("tr");
      const cells = [
        it.asset||"",
        (it.free??0).toString(),
        (it.used??0).toString(),
        (it.total??0).toString(),
        it.price_eur!=null? Number(it.price_eur).toFixed(6): "-",
        it.value_eur!=null? Number(it.value_eur).toFixed(2): "-"
      ];
      cells.forEach((c,i)=>{
        const td = document.createElement("td");
        if (i>=1) td.className = "num";
        td.textContent = c;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    totalEl.textContent = d.total_value_eur!=null? Number(d.total_value_eur).toFixed(2): "-";
  }catch(e){
    tbody.innerHTML = `<tr><td colspan="6" style="color:#b00;">Error: ${e.message}</td></tr>`;
    totalEl.textContent = "-";
  }
}

async function loadFavs(){
  const tbody = document.getElementById("favbody");
  tbody.innerHTML = `<tr><td colspan="8">Loading...</td></tr>`;
  try{
    const d = await get("/api/favorites");
    const items = d.items || [];
    tbody.innerHTML = "";
    if (items.length === 0){
      tbody.innerHTML = `<tr><td colspan="8">No favorites found.</td></tr>`;
      return;
    }
    items.forEach(it=>{
      const tr = document.createElement("tr");
      const cells = [
        it.name||"",
        it.asset||"",
        it.last_price!=null? Number(it.last_price).toFixed(2): "-",
        it.sma_short!=null? Number(it.sma_short).toFixed(2): "-",
        it.sma_long!=null? Number(it.sma_long).toFixed(2): "-",
        it.rsi!=null? Number(it.rsi).toFixed(1): "-",
        it.signal||"",
        it.error||""
      ];
      cells.forEach((c,i)=>{
        const td = document.createElement("td");
        if ([2,3,4,5].includes(i)) td.className="num";
        td.textContent = c;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }catch(e){
    tbody.innerHTML = `<tr><td colspan="8" style="color:#b00;">Error: ${e.message}</td></tr>`;
  }
}

async function syncPrices(kind){
  const assetInput = document.getElementById('syncAsset');
  const asset = (assetInput.value || 'ALL').trim();
  try{
    const res = await post('/api/sync', {asset, kind});
    alert(`Sync ok.\nSynced: ${res.synced.length}\nErrors: ${res.errors.length}`);
    loadFavs();
  }catch(e){
    alert('Sync failed: ' + e.message);
  }
}

setInterval(refresh, 3000);
setInterval(()=>{ if (document.getElementById('tab-favorites').classList.contains('active')) loadFavs(); }, 15000);
loadConf(); refresh(); loadHoldings(); loadFavs();
</script>
</body>
</html>
